<%- include('partials/header') %>

<% if (typeof success !== 'undefined' && success) { %>
<div class="alert alert-success">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
  Settings saved successfully!
</div>
<% } %>

<form action="/admin/settings" method="POST" enctype="multipart/form-data">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
    <!-- General Settings -->
    <div class="card">
      <div class="card-header">
        <h2>General Settings</h2>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="site_name">Site Name</label>
          <input type="text" id="site_name" name="site_name" value="<%= settings.site_name || '' %>">
        </div>
        
        <div class="form-group">
          <label for="site_tagline">Tagline</label>
          <input type="text" id="site_tagline" name="site_tagline" value="<%= settings.site_tagline || '' %>">
        </div>
        
        <div class="form-group">
          <label for="hero_title">Hero Title</label>
          <input type="text" id="hero_title" name="hero_title" value="<%= settings.hero_title || '' %>">
        </div>
        
        <div class="form-group">
          <label for="hero_subtitle">Hero Subtitle</label>
          <textarea id="hero_subtitle" name="hero_subtitle" rows="2"><%= settings.hero_subtitle || '' %></textarea>
        </div>
        
        <div class="form-group">
          <label for="about_text">About Text</label>
          <textarea id="about_text" name="about_text" rows="3"><%= settings.about_text || '' %></textarea>
        </div>
        
        <div class="form-group">
          <label for="footer_text">Footer Text</label>
          <input type="text" id="footer_text" name="footer_text" value="<%= settings.footer_text || '' %>">
        </div>

        <div class="form-group">
          <label for="privacy_url">Privacy Policy URL</label>
          <input type="text" id="privacy_url" name="privacy_url" value="<%= settings.privacy_url || '/privacy' %>" placeholder="/privacy or https://...">
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Use /privacy for the built-in page, or enter a full URL for an external page.</small>
        </div>

        <div class="form-group">
          <label for="terms_url">Terms of Service URL</label>
          <input type="text" id="terms_url" name="terms_url" value="<%= settings.terms_url || '/terms' %>" placeholder="/terms or https://...">
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Use /terms for the built-in page, or enter a full URL for an external page.</small>
        </div>
      </div>
    </div>

    <!-- Contact Info -->
    <div class="card">
      <div class="card-header">
        <h2>Contact Information</h2>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="text" id="phone" name="phone" value="<%= settings.phone || '' %>">
        </div>
        
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" value="<%= settings.email || '' %>">
        </div>
        
        <div class="form-group">
          <label for="address">Street Address</label>
          <input type="text" id="address" name="address" value="<%= settings.address || '' %>">
        </div>
        
        <div class="form-group">
          <label for="city">City, State, ZIP</label>
          <input type="text" id="city" name="city" value="<%= settings.city || '' %>">
        </div>
        
        <div class="form-group">
          <label for="hours_weekday">Weekday Hours</label>
          <input type="text" id="hours_weekday" name="hours_weekday" value="<%= settings.hours_weekday || '' %>">
        </div>
        
        <div class="form-group">
          <label for="hours_weekend">Weekend Hours</label>
          <input type="text" id="hours_weekend" name="hours_weekend" value="<%= settings.hours_weekend || '' %>">
        </div>
      </div>
    </div>
    
    <!-- Site Logo -->
    <div class="card">
      <div class="card-header">
        <h2>Site Logo</h2>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="site_logo">Header Logo</label>
          <% if (settings.site_logo) { %>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem; text-align: center;">
              <p style="font-size: 0.875rem; color: #64748B; margin-bottom: 0.5rem;">Current Logo:</p>
              <img src="<%= settings.site_logo %>" alt="Current logo" style="max-height: 80px; max-width: 100%; object-fit: contain;">
            </div>
          <% } else { %>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem; text-align: center;">
              <p style="font-size: 0.875rem; color: #64748B; margin: 0;">No logo uploaded. Using default SVG logo.</p>
            </div>
          <% } %>
          <input type="file" id="site_logo" name="site_logo" accept="image/png,image/jpeg,image/svg+xml,image/webp" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.5rem;">
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Displayed in the navigation bar (light background). Supports PNG, JPG, SVG, WebP.</small>
        </div>

        <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #E2E8F0;">
          <label for="footer_logo">Footer Logo</label>
          <% if (settings.footer_logo) { %>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #1E293B; border-radius: 0.5rem; text-align: center;">
              <p style="font-size: 0.875rem; color: #94A3B8; margin-bottom: 0.5rem;">Current Logo:</p>
              <img src="<%= settings.footer_logo %>" alt="Current footer logo" style="max-height: 80px; max-width: 100%; object-fit: contain;">
            </div>
          <% } else { %>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #1E293B; border-radius: 0.5rem; text-align: center;">
              <p style="font-size: 0.875rem; color: #94A3B8; margin: 0;">No footer logo uploaded. Using default SVG logo.</p>
            </div>
          <% } %>
          <input type="file" id="footer_logo" name="footer_logo" accept="image/png,image/jpeg,image/svg+xml,image/webp" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.5rem;">
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Displayed in the footer (dark background). Use a light-colored or inverted version if needed.</small>
        </div>

        <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #E2E8F0;">
          <label for="favicon">Favicon</label>
          <% if (settings.favicon) { %>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem; text-align: center;">
              <p style="font-size: 0.875rem; color: #64748B; margin-bottom: 0.5rem;">Current Favicon:</p>
              <img src="<%= settings.favicon %>" alt="Current favicon" style="width: 32px; height: 32px; object-fit: contain;">
            </div>
          <% } else { %>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem; text-align: center;">
              <p style="font-size: 0.875rem; color: #64748B; margin: 0;">No favicon uploaded. Using default tooth icon.</p>
            </div>
          <% } %>
          <input type="file" id="favicon" name="favicon" accept="image/png,image/svg+xml,image/x-icon,image/ico" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.5rem;">
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Browser tab icon. Recommended: 32x32px PNG or SVG. Supports PNG, SVG, ICO.</small>
        </div>
      </div>
    </div>

    <!-- Social Media -->
    <div class="card">
      <div class="card-header">
        <h2>Social Media</h2>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="facebook">Facebook URL</label>
          <input type="url" id="facebook" name="facebook" value="<%= settings.facebook || '' %>" placeholder="https://facebook.com/...">
        </div>

        <div class="form-group">
          <label for="instagram">Instagram URL</label>
          <input type="url" id="instagram" name="instagram" value="<%= settings.instagram || '' %>" placeholder="https://instagram.com/...">
        </div>

        <div class="form-group">
          <label for="twitter">Twitter URL</label>
          <input type="url" id="twitter" name="twitter" value="<%= settings.twitter || '' %>" placeholder="https://twitter.com/...">
        </div>
      </div>
    </div>

    <!-- Email Notifications -->
    <div class="card">
      <div class="card-header">
        <h2>Email Notifications</h2>
      </div>
      <div class="card-body">
        <p style="color: #64748B; margin-bottom: 1.5rem;">Configure SMTP settings to receive email notifications when someone submits a contact form or lead capture form.</p>

        <div class="form-group">
          <label for="notification_email">Notification Email</label>
          <input type="email" id="notification_email" name="notification_email" value="<%= settings.notification_email || '' %>" placeholder="admin@yourdomain.com">
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Where to send notification emails. Defaults to Contact Email if not set.</small>
        </div>

        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #E2E8F0;">
          <h4 style="font-size: 0.875rem; font-weight: 600; color: #334155; margin-bottom: 1rem;">SMTP Settings</h4>

          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="smtp_host" style="font-size: 0.8125rem;">SMTP Host</label>
              <input type="text" id="smtp_host" name="smtp_host" value="<%= settings.smtp_host || '' %>" placeholder="smtp.gmail.com" style="padding: 0.5rem;">
            </div>
            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="smtp_port" style="font-size: 0.8125rem;">Port</label>
              <input type="number" id="smtp_port" name="smtp_port" value="<%= settings.smtp_port || '587' %>" placeholder="587" style="padding: 0.5rem;">
            </div>
          </div>

          <div class="form-group" style="margin-bottom: 0.75rem;">
            <label for="smtp_user" style="font-size: 0.8125rem;">SMTP Username</label>
            <input type="text" id="smtp_user" name="smtp_user" value="<%= settings.smtp_user || '' %>" placeholder="your-email@gmail.com" style="padding: 0.5rem;">
          </div>

          <div class="form-group" style="margin-bottom: 0.75rem;">
            <label for="smtp_pass" style="font-size: 0.8125rem;">SMTP Password</label>
            <input type="password" id="smtp_pass" name="smtp_pass" value="<%= settings.smtp_pass || '' %>" placeholder="App password or SMTP password" style="padding: 0.5rem;">
            <small style="color: #64748B; display: block; margin-top: 0.25rem;">For Gmail, use an <a href="https://support.google.com/accounts/answer/185833" target="_blank" style="color: #0077B6;">App Password</a>.</small>
          </div>

          <div class="form-group" style="margin-bottom: 0.75rem;">
            <label for="smtp_from" style="font-size: 0.8125rem;">From Email (optional)</label>
            <input type="email" id="smtp_from" name="smtp_from" value="<%= settings.smtp_from || '' %>" placeholder="noreply@yourdomain.com" style="padding: 0.5rem;">
            <small style="color: #64748B; display: block; margin-top: 0.25rem;">Defaults to SMTP username if not set.</small>
          </div>

          <div class="form-group" style="margin-bottom: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.8125rem;">
              <input type="checkbox" name="smtp_secure" value="true" <%= settings.smtp_secure === 'true' ? 'checked' : '' %> style="width: 16px; height: 16px;">
              <span>Use SSL/TLS (port 465)</span>
            </label>
          </div>

          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.8125rem;">
              <input type="checkbox" name="send_contact_confirmation" value="true" <%= settings.send_contact_confirmation === 'true' ? 'checked' : '' %> style="width: 16px; height: 16px;">
              <span>Send confirmation email to visitors after form submission</span>
            </label>
          </div>
        </div>

        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #E2E8F0;">
          <button type="button" id="test-email-btn" class="btn btn-secondary" style="width: 100%;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            Test Email Configuration
          </button>
          <div id="test-email-result" style="margin-top: 0.75rem; display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Page Images -->
    <div class="card">
      <div class="card-header">
        <h2>Page Images</h2>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="contact_success_image">Contact Form Success Image</label>
          <% if (settings.contact_success_image) { %>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #D1FAE5; border-radius: 0.5rem; text-align: center;">
              <p style="font-size: 0.875rem; color: #065F46; margin-bottom: 0.5rem;">Current Image:</p>
              <img src="<%= settings.contact_success_image %>" alt="Contact Success" style="max-height: 150px; max-width: 100%; object-fit: contain; border-radius: 0.375rem;">
            </div>
          <% } else { %>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem; text-align: center;">
              <p style="font-size: 0.875rem; color: #64748B; margin: 0;">No custom image. Using default checkmark icon.</p>
            </div>
          <% } %>
          <input type="file" id="contact_success_image" name="contact_success_image" accept="image/png,image/jpeg,image/webp,image/gif" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.5rem;">
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Displayed after a visitor submits the contact form. Recommended: 400x300px.</small>
        </div>

      </div>
    </div>

    <!-- Site Theme -->
    <div class="card">
      <div class="card-header">
        <h2>Site Theme</h2>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="site_theme">Theme</label>
          <select id="site_theme" name="site_theme" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.5rem; font-size: 1rem;">
            <option value="normal" <%= settings.site_theme === 'normal' ? 'selected' : '' %>>Normal (Blue/Cyan)</option>
            <option value="fall" <%= settings.site_theme === 'fall' ? 'selected' : '' %>>Fall (Amber/Orange)</option>
            <option value="winter" <%= settings.site_theme === 'winter' ? 'selected' : '' %>>Winter (Sky Blue/Ice)</option>
          </select>
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Changes the color scheme across the entire website.</small>
        </div>

        <div style="margin-top: 1rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem;">
          <strong style="font-size: 0.875rem; color: #334155;">Theme Preview:</strong>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; align-items: center;" id="theme-preview">
            <div id="preview-primary" style="width: 40px; height: 40px; border-radius: 0.375rem; transition: background 0.3s;" title="Primary"></div>
            <div id="preview-accent" style="width: 40px; height: 40px; border-radius: 0.375rem; transition: background 0.3s;" title="Accent"></div>
            <div id="preview-secondary" style="width: 40px; height: 40px; border-radius: 0.375rem; transition: background 0.3s;" title="Secondary"></div>
            <span id="preview-labels" style="margin-left: 1rem; font-size: 0.8125rem; color: #64748B;"></span>
          </div>
        </div>

        <!-- Fall Theme Animation -->
        <div id="fall-animation-option" class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #E2E8F0; display: <%= settings.site_theme === 'fall' ? 'block' : 'none' %>;">
          <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
            <input type="checkbox" name="show_falling_leaves" value="true" <%= settings.show_falling_leaves === 'true' ? 'checked' : '' %> style="width: 20px; height: 20px; accent-color: #B45309;">
            <span style="font-weight: 600;">Enable Falling Leaves Animation</span>
          </label>
          <small style="color: #64748B; display: block; margin-top: 0.5rem; margin-left: 2rem;">Adds animated falling leaves to the hero section. Great for fall/autumn seasonal feel!</small>
        </div>

        <!-- Winter Theme Animation -->
        <div id="winter-animation-option" class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #E2E8F0; display: <%= settings.site_theme === 'winter' ? 'block' : 'none' %>;">
          <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
            <input type="checkbox" name="show_falling_snow" value="true" <%= settings.show_falling_snow === 'true' ? 'checked' : '' %> style="width: 20px; height: 20px; accent-color: #0EA5E9;">
            <span style="font-weight: 600;">Enable Falling Snow Animation</span>
          </label>
          <small style="color: #64748B; display: block; margin-top: 0.5rem; margin-left: 2rem;">Adds animated falling snowflakes to the hero section. Perfect for winter/holiday feel!</small>
        </div>
      </div>
    </div>

    <!-- Reviews Settings -->
    <div class="card">
      <div class="card-header">
        <h2>Reviews Settings</h2>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label for="reviews_source">Reviews Source</label>
          <select id="reviews_source" name="reviews_source" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.5rem; font-size: 1rem;">
            <option value="manual" <%= (!settings.reviews_source || settings.reviews_source === 'manual') ? 'selected' : '' %>>Manual Entry (Recommended)</option>
            <option value="google_api" <%= settings.reviews_source === 'google_api' ? 'selected' : '' %>>Google Places API</option>
            <option value="third_party" <%= settings.reviews_source === 'third_party' ? 'selected' : '' %>>Third-Party Service</option>
          </select>
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Manual entry is recommended - you control which reviews appear on your site.</small>
        </div>

        <div id="google-api-settings" style="margin-top: 1.5rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem; display: <%= settings.reviews_source === 'google_api' ? 'block' : 'none' %>;">
          <h4 style="font-size: 0.875rem; font-weight: 600; color: #334155; margin-bottom: 1rem;">Google Places API Settings</h4>

          <div class="form-group" style="margin-bottom: 1rem;">
            <label for="google_places_api_key">API Key</label>
            <input type="password" id="google_places_api_key" name="google_places_api_key" value="<%= settings.google_places_api_key || '' %>" placeholder="AIza..." style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.5rem;">
            <small style="color: #64748B; display: block; margin-top: 0.25rem;">Get your API key from the <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #0077B6;">Google Cloud Console</a></small>
          </div>

          <div class="form-group">
            <label for="google_place_id">Place ID</label>
            <input type="text" id="google_place_id" name="google_place_id" value="<%= settings.google_place_id || '' %>" placeholder="ChIJ..." style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.5rem;">
            <small style="color: #64748B; display: block; margin-top: 0.25rem;">Find your Place ID using the <a href="https://developers.google.com/maps/documentation/places/web-service/place-id" target="_blank" style="color: #0077B6;">Place ID Finder</a></small>
          </div>

          <div class="form-group" style="margin-top: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
              <input type="checkbox" name="google_auto_sync" value="true" <%= settings.google_auto_sync === 'true' ? 'checked' : '' %> style="width: 20px; height: 20px; accent-color: #EA4335;">
              <span style="font-weight: 600;">Enable Auto-Sync (every 24 hours)</span>
            </label>
            <small style="color: #64748B; display: block; margin-top: 0.5rem; margin-left: 2rem;">Automatically fetch new Google reviews daily. You can also manually sync from the Reviews page.</small>
          </div>

          <div style="margin-top: 1rem; padding: 0.75rem; background: #FEF3C7; border-radius: 0.375rem; font-size: 0.875rem; color: #92400E;">
            <strong>Note:</strong> Google Places API requires a billing account. Costs approximately $0.02 per review fetch.
          </div>
        </div>

        <div id="third-party-settings" style="margin-top: 1.5rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem; display: <%= settings.reviews_source === 'third_party' ? 'block' : 'none' %>;">
          <h4 style="font-size: 0.875rem; font-weight: 600; color: #334155; margin-bottom: 1rem;">Third-Party Integration</h4>

          <div class="form-group">
            <label for="third_party_embed_code">Embed Code</label>
            <textarea id="third_party_embed_code" name="third_party_embed_code" rows="4" placeholder="Paste embed code from services like Birdeye, Podium, or ReviewTrackers..." style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.5rem; font-family: monospace; font-size: 0.875rem;"><%= settings.third_party_embed_code || '' %></textarea>
            <small style="color: #64748B; display: block; margin-top: 0.25rem;">Paste the embed code from your review management service.</small>
          </div>
        </div>

        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #E2E8F0;">
          <a href="/admin/reviews" class="btn btn-secondary" style="width: 100%; text-align: center;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            Manage Reviews
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Settings -->
  <div style="grid-column: 1 / -1; margin-top: 1.5rem;">
    <div class="card">
      <div class="card-header">
        <h2>Navigation Menu</h2>
      </div>
      <div class="card-body">
        <p style="color: #64748B; margin-bottom: 1.5rem;">Configure the main navigation links. Use the "Parent" dropdown to create dropdown submenus.</p>

        <div id="nav-items-container">
          <%
            let navItems = [];
            try {
              navItems = JSON.parse(settings.main_nav_links || '[]');
            } catch (e) {
              // Default navigation items
              navItems = [
                { label: 'Home', url: '/', visible: true, parent: '' },
                { label: 'About', url: '/about', visible: true, parent: '' },
                { label: 'Services', url: '/services', visible: true, parent: '' },
                { label: 'Locations', url: '/locations', visible: true, parent: '' },
                { label: 'Mobile Dentistry', url: '/mobile-dentistry', visible: true, parent: '' },
                { label: 'Blog', url: '/blog', visible: true, parent: '' },
                { label: 'Contact', url: '/contact', visible: true, parent: '' }
              ];
            }
            if (navItems.length === 0) {
              navItems = [
                { label: 'Home', url: '/', visible: true, parent: '' },
                { label: 'About', url: '/about', visible: true, parent: '' },
                { label: 'Services', url: '/services', visible: true, parent: '' },
                { label: 'Locations', url: '/locations', visible: true, parent: '' },
                { label: 'Mobile Dentistry', url: '/mobile-dentistry', visible: true, parent: '' },
                { label: 'Blog', url: '/blog', visible: true, parent: '' },
                { label: 'Contact', url: '/contact', visible: true, parent: '' }
              ];
            }
            // Get list of top-level items for parent dropdown
            const topLevelItems = navItems.filter(item => !item.parent);
          %>
          <!-- Column Headers -->
          <div style="display: grid; grid-template-columns: 60px 1.5fr 1fr 140px 70px 40px; gap: 0.5rem; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px;">
            <div>Order</div>
            <div>Menu Label</div>
            <div>URL</div>
            <div>Nest Under</div>
            <div>Show</div>
            <div></div>
          </div>

          <% navItems.forEach((item, index) => { %>
          <div class="nav-item-row" data-index="<%= index %>" style="display: grid; grid-template-columns: 60px 1.5fr 1fr 140px 70px 40px; gap: 0.5rem; align-items: center; padding: 0.75rem; background: <%= item.parent ? '#EEF2FF' : '#F8FAFC' %>; border-radius: 0.5rem; margin-bottom: 0.5rem; <%= item.parent ? 'margin-left: 1.5rem; border-left: 3px solid #6366F1;' : '' %>">
            <!-- Order/Move buttons -->
            <div style="display: flex; align-items: center; gap: 0.25rem;">
              <span style="font-weight: 600; color: #94A3B8; font-size: 0.75rem; width: 20px;"><%= index + 1 %>.</span>
              <div class="move-buttons" style="display: flex; flex-direction: column; gap: 2px;">
                <button type="button" onclick="moveNavItem(<%= index %>, -1)" class="move-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move up">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="18 15 12 9 6 15"/></svg>
                </button>
                <button type="button" onclick="moveNavItem(<%= index %>, 1)" class="move-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move down">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
              </div>
            </div>

            <!-- Menu Label -->
            <input type="text" name="nav_label_<%= index %>" value="<%= item.label %>" placeholder="e.g., About Us" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500;">

            <!-- URL -->
            <input type="text" name="nav_url_<%= index %>" value="<%= item.url %>" placeholder="/page-url" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem; font-family: monospace; color: #6366F1;">

            <!-- Nest Under (Parent) -->
            <select name="nav_parent_<%= index %>" class="nav-parent-select" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.8125rem; background: white;">
              <option value="">— None —</option>
              <% navItems.forEach((parentItem, parentIndex) => { %>
                <% if (parentIndex !== index && !parentItem.parent) { %>
                  <option value="<%= parentItem.label %>" <%= item.parent === parentItem.label ? 'selected' : '' %>>↳ <%= parentItem.label %></option>
                <% } %>
              <% }); %>
            </select>

            <!-- Visible Toggle -->
            <label style="display: flex; align-items: center; justify-content: center; cursor: pointer;">
              <input type="checkbox" name="nav_visible_<%= index %>" value="true" <%= item.visible !== false ? 'checked' : '' %> style="width: 18px; height: 18px; accent-color: #0077B6;">
            </label>

            <!-- Delete -->
            <button type="button" onclick="removeNavItem(<%= index %>)" class="remove-nav-btn" style="background: none; border: none; cursor: pointer; padding: 0.5rem; color: #EF4444;" title="Remove this item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          <% }); %>
        </div>

        <input type="hidden" id="main_nav_links" name="main_nav_links" value='<%= JSON.stringify(navItems) %>'>
        <input type="hidden" id="nav_item_count" name="nav_item_count" value="<%= navItems.length %>">

        <button type="button" onclick="addNavItem()" class="btn btn-secondary" style="margin-top: 1rem;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Navigation Item
        </button>

        <div style="margin-top: 1rem; padding: 0.75rem; background: #DBEAFE; border-radius: 0.375rem; font-size: 0.875rem; color: #1E40AF;">
          <strong>Tip:</strong> Select a "Parent" to create dropdown submenus. Items with a parent will appear as dropdown items under that parent.
        </div>
      </div>
    </div>
  </div>

  <!-- Trust Credentials Section -->
  <div style="grid-column: 1 / -1; margin-top: 1.5rem;">
    <div class="card">
      <div class="card-header">
        <h2>Trust Credentials (Homepage)</h2>
      </div>
      <div class="card-body">
        <p style="color: #64748B; margin-bottom: 1.5rem;">Manage the "Trusted & Accredited" logos displayed on your homepage. Upload credential images to <code style="background: #E2E8F0; padding: 0.125rem 0.375rem; border-radius: 0.25rem;">/public/images/credentials/</code></p>

        <div id="credentials-container">
          <%
            let credentials = [];
            try {
              credentials = JSON.parse(settings.trust_credentials || '[]');
            } catch (e) {
              credentials = [];
            }
            // Default credentials if none configured
            if (credentials.length === 0) {
              credentials = [
                { name: 'American Dental Association', abbrev: 'ADA', image: '/images/credentials/ada-logo.png', visible: true },
                { name: 'NYU College of Dentistry', abbrev: 'NYU', image: '/images/credentials/nyu-dentistry-logo.png', visible: true },
                { name: 'New York State Licensed', abbrev: 'NY', image: '/images/credentials/ny-dental-license.png', visible: true },
                { name: 'Connecticut State Licensed', abbrev: 'CT', image: '/images/credentials/ct-dental-license.png', visible: true }
              ];
            }
          %>
          <!-- Column Headers -->
          <div style="display: grid; grid-template-columns: 50px 1fr 70px 1fr 80px 50px 36px; gap: 0.5rem; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; font-size: 0.7rem; font-weight: 600; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px;">
            <div>Order</div>
            <div>Credential Name</div>
            <div>Abbrev</div>
            <div>Image</div>
            <div style="text-align: center;">Upload</div>
            <div style="text-align: center;">Show</div>
            <div></div>
          </div>

          <% credentials.forEach((cred, index) => { %>
          <div class="credential-row" data-index="<%= index %>" style="display: grid; grid-template-columns: 50px 1fr 70px 1fr 80px 50px 36px; gap: 0.5rem; align-items: center; padding: 0.75rem; background: #F8FAFC; border-radius: 0.5rem; margin-bottom: 0.5rem;">
            <!-- Order/Move buttons -->
            <div style="display: flex; align-items: center; gap: 0.25rem;">
              <span style="font-weight: 600; color: #94A3B8; font-size: 0.75rem; width: 18px;"><%= index + 1 %>.</span>
              <div class="move-buttons" style="display: flex; flex-direction: column; gap: 2px;">
                <button type="button" onclick="moveCredential(<%= index %>, -1)" class="move-cred-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move up">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="18 15 12 9 6 15"/></svg>
                </button>
                <button type="button" onclick="moveCredential(<%= index %>, 1)" class="move-cred-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move down">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
              </div>
            </div>

            <!-- Credential Name -->
            <input type="text" name="cred_name_<%= index %>" value="<%= cred.name %>" placeholder="e.g., American Dental Association" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.8125rem;">

            <!-- Abbreviation -->
            <input type="text" name="cred_abbrev_<%= index %>" value="<%= cred.abbrev %>" placeholder="ADA" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.8125rem; text-align: center; font-weight: 600;">

            <!-- Image Path with Preview -->
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <% if (cred.image) { %>
              <img src="<%= cred.image %>" alt="" style="width: 28px; height: 28px; object-fit: contain; border-radius: 4px; background: white; border: 1px solid #E2E8F0;" onerror="this.style.display='none'">
              <% } %>
              <input type="text" name="cred_image_<%= index %>" value="<%= cred.image %>" placeholder="/uploads/logo.png" style="flex: 1; padding: 0.4rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.7rem; font-family: monospace; color: #6366F1;">
            </div>

            <!-- Upload Button -->
            <div style="display: flex; justify-content: center;">
              <input type="file" id="cred_file_<%= index %>" accept="image/*" style="display: none;" onchange="uploadCredentialImage(this, <%= index %>)">
              <button type="button" onclick="document.getElementById('cred_file_<%= index %>').click()" class="cred-upload-btn" style="padding: 0.4rem 0.6rem; background: #0077B6; color: white; border: none; border-radius: 0.375rem; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;" title="Upload image">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Upload
              </button>
            </div>

            <!-- Visible Toggle -->
            <label style="display: flex; align-items: center; justify-content: center; cursor: pointer;">
              <input type="checkbox" name="cred_visible_<%= index %>" value="true" <%= cred.visible !== false ? 'checked' : '' %> style="width: 18px; height: 18px; accent-color: #0077B6;">
            </label>

            <!-- Delete -->
            <button type="button" onclick="removeCredential(<%= index %>)" class="remove-cred-btn" style="background: none; border: none; cursor: pointer; padding: 0.5rem; color: #EF4444;" title="Remove this credential">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          <% }); %>
        </div>

        <input type="hidden" id="trust_credentials" name="trust_credentials" value='<%= JSON.stringify(credentials) %>'>

        <button type="button" onclick="addCredential()" class="btn btn-secondary" style="margin-top: 1rem;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Credential
        </button>

        <div style="margin-top: 1rem; padding: 0.75rem; background: #D1FAE5; border-radius: 0.375rem; font-size: 0.875rem; color: #065F46;">
          <strong>Tip:</strong> Click "Upload" to add a logo image, or manually enter a path if the image already exists on the server.
        </div>
      </div>
    </div>
  </div>

  <!-- Footer Content Section -->
  <div style="grid-column: 1 / -1; margin-top: 1.5rem;">
    <div class="card">
      <div class="card-header">
        <h2>Footer Content</h2>
      </div>
      <div class="card-body">
        <p style="color: #64748B; margin-bottom: 1.5rem;">Configure the locations and quick links displayed in your website footer.</p>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
          <!-- Location 1 -->
          <div style="padding: 1rem; background: #F8FAFC; border-radius: 0.5rem;">
            <h4 style="font-size: 0.875rem; font-weight: 600; color: #334155; margin-bottom: 1rem;">Location 1 (Primary)</h4>

            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="footer_location1_name" style="font-size: 0.8125rem;">Name</label>
              <input type="text" id="footer_location1_name" name="footer_location1_name" value="<%= settings.footer_location1_name || '' %>" placeholder="e.g., Main Office" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>

            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="footer_location1_address" style="font-size: 0.8125rem;">Street Address</label>
              <input type="text" id="footer_location1_address" name="footer_location1_address" value="<%= settings.footer_location1_address || '' %>" placeholder="e.g., 123 Main St" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>

            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="footer_location1_city" style="font-size: 0.8125rem;">City, State, ZIP</label>
              <input type="text" id="footer_location1_city" name="footer_location1_city" value="<%= settings.footer_location1_city || '' %>" placeholder="e.g., Buffalo, NY 14210" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.8125rem;">
                <input type="checkbox" name="footer_location1_show_phone" value="true" <%= settings.footer_location1_show_phone === 'true' ? 'checked' : '' %> style="width: 16px; height: 16px;">
                <span>Show phone number</span>
              </label>
            </div>
          </div>

          <!-- Location 2 -->
          <div style="padding: 1rem; background: #F8FAFC; border-radius: 0.5rem;">
            <h4 style="font-size: 0.875rem; font-weight: 600; color: #334155; margin-bottom: 1rem;">Location 2</h4>

            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="footer_location2_name" style="font-size: 0.8125rem;">Name</label>
              <input type="text" id="footer_location2_name" name="footer_location2_name" value="<%= settings.footer_location2_name || '' %>" placeholder="e.g., Coming Soon Location" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>

            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="footer_location2_text" style="font-size: 0.8125rem;">Description Text</label>
              <input type="text" id="footer_location2_text" name="footer_location2_text" value="<%= settings.footer_location2_text || '' %>" placeholder="e.g., Coming Soon!" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>

            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="footer_location2_link_text" style="font-size: 0.8125rem;">Link Text</label>
              <input type="text" id="footer_location2_link_text" name="footer_location2_link_text" value="<%= settings.footer_location2_link_text || '' %>" placeholder="e.g., Reserve Your Spot" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>

            <div class="form-group">
              <label for="footer_location2_link_url" style="font-size: 0.8125rem;">Link URL</label>
              <input type="text" id="footer_location2_link_url" name="footer_location2_link_url" value="<%= settings.footer_location2_link_url || '' %>" placeholder="e.g., /contact?location=new" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>
          </div>

          <!-- Location 3 -->
          <div style="padding: 1rem; background: #F8FAFC; border-radius: 0.5rem;">
            <h4 style="font-size: 0.875rem; font-weight: 600; color: #334155; margin-bottom: 1rem;">Location 3</h4>

            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="footer_location3_name" style="font-size: 0.8125rem;">Name</label>
              <input type="text" id="footer_location3_name" name="footer_location3_name" value="<%= settings.footer_location3_name || '' %>" placeholder="e.g., Mobile Dentistry" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>

            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="footer_location3_text" style="font-size: 0.8125rem;">Description Text</label>
              <input type="text" id="footer_location3_text" name="footer_location3_text" value="<%= settings.footer_location3_text || '' %>" placeholder="e.g., Serving all of NY State" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>

            <div class="form-group" style="margin-bottom: 0.75rem;">
              <label for="footer_location3_link_text" style="font-size: 0.8125rem;">Link Text</label>
              <input type="text" id="footer_location3_link_text" name="footer_location3_link_text" value="<%= settings.footer_location3_link_text || '' %>" placeholder="e.g., Learn More" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>

            <div class="form-group">
              <label for="footer_location3_link_url" style="font-size: 0.8125rem;">Link URL</label>
              <input type="text" id="footer_location3_link_url" name="footer_location3_link_url" value="<%= settings.footer_location3_link_url || '' %>" placeholder="e.g., /mobile-dentistry" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem;">
            </div>
          </div>
        </div>

        <!-- Quick Links -->
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #E2E8F0;">
          <h4 style="font-size: 0.875rem; font-weight: 600; color: #334155; margin-bottom: 1rem;">Quick Links</h4>
          <p style="font-size: 0.8125rem; color: #64748B; margin-bottom: 1rem;">Enter links as JSON array. Format: [{"label":"Link Text","url":"/page-url"}]</p>

          <div class="form-group">
            <textarea id="footer_quick_links" name="footer_quick_links" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #E2E8F0; border-radius: 0.5rem; font-family: monospace; font-size: 0.875rem;"><%= settings.footer_quick_links || '[{"label":"Home","url":"/"},{"label":"About Us","url":"/about"},{"label":"Our Services","url":"/services"},{"label":"Contact","url":"/contact"}]' %></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top: 1.5rem;">
    <button type="submit" class="btn btn-primary btn-lg">Save All Settings</button>
  </div>
</form>

<!-- Backup & Restore Section (outside main settings form) -->
<div style="margin-top: 2rem;">
  <div class="card">
    <div class="card-header">
      <h2>Backup & Restore</h2>
    </div>
    <div class="card-body">
      <p style="color: #64748B; margin-bottom: 1.5rem;">Export all your site configuration and content as a JSON file, or restore from a previous backup.</p>

      <% if (typeof importSuccess !== 'undefined' && importSuccess) { %>
      <div class="alert alert-success" style="margin-bottom: 1.5rem;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        Backup restored successfully!
      </div>
      <% } %>

      <% if (typeof importError !== 'undefined' && importError) { %>
      <div class="alert alert-danger" style="margin-bottom: 1.5rem;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        <%= importError %>
      </div>
      <% } %>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <!-- Export -->
        <div style="padding: 1.5rem; background: #F0FDF4; border: 1px solid #86EFAC; border-radius: 0.5rem;">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#16A34A" stroke-width="2" style="width: 24px; height: 24px;">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            <h4 style="font-weight: 600; color: #166534; margin: 0;">Export Configuration</h4>
          </div>
          <p style="font-size: 0.875rem; color: #166534; margin-bottom: 1rem;">Download a complete backup of all settings, pages, posts, services, team members, testimonials, and reviews.</p>
          <a href="/admin/export" class="btn btn-primary" style="background: #16A34A; border-color: #16A34A;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Download Backup
          </a>
        </div>

        <!-- Import -->
        <div style="padding: 1.5rem; background: #FEF3C7; border: 1px solid #FCD34D; border-radius: 0.5rem;">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2" style="width: 24px; height: 24px;">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <h4 style="font-weight: 600; color: #92400E; margin: 0;">Restore from Backup</h4>
          </div>
          <p style="font-size: 0.875rem; color: #92400E; margin-bottom: 1rem;">Upload a previously exported JSON backup file to restore your configuration. This will overwrite existing data.</p>
          <form action="/admin/import" method="POST" enctype="multipart/form-data" style="display: flex; gap: 0.75rem; align-items: flex-end;">
            <div style="flex: 1;">
              <input type="file" name="backup_file" accept=".json,application/json" required style="width: 100%; padding: 0.5rem; border: 1px solid #FCD34D; border-radius: 0.375rem; background: white; font-size: 0.875rem;">
            </div>
            <button type="submit" class="btn btn-primary" style="background: #D97706; border-color: #D97706;" onclick="return confirm('Are you sure you want to restore from this backup? This will overwrite your current configuration.');">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Restore
            </button>
          </form>
        </div>
      </div>

      <div style="margin-top: 1.5rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem; font-size: 0.875rem; color: #64748B;">
        <strong style="color: #334155;">Note:</strong> Backups include all text content and configuration but do not include uploaded images. Image files should be backed up separately from the <code style="background: #E2E8F0; padding: 0.125rem 0.375rem; border-radius: 0.25rem;">/uploads</code> directory.
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('reviews_source').addEventListener('change', function() {
  document.getElementById('google-api-settings').style.display = this.value === 'google_api' ? 'block' : 'none';
  document.getElementById('third-party-settings').style.display = this.value === 'third_party' ? 'block' : 'none';
});

// Theme preview and animation options
const themeColors = {
  normal: { primary: '#0077B6', accent: '#84CC16', secondary: '#1A365D', label: 'Primary, Accent, Secondary' },
  fall: { primary: '#B45309', accent: '#DC2626', secondary: '#78350F', label: 'Amber, Red, Brown' },
  winter: { primary: '#0EA5E9', accent: '#06B6D4', secondary: '#1E3A5F', label: 'Sky Blue, Cyan, Navy' }
};

function updateThemePreview(theme) {
  const colors = themeColors[theme] || themeColors.normal;
  document.getElementById('preview-primary').style.background = colors.primary;
  document.getElementById('preview-accent').style.background = colors.accent;
  document.getElementById('preview-secondary').style.background = colors.secondary;
  document.getElementById('preview-labels').textContent = colors.label;

  // Show/hide animation options based on theme
  document.getElementById('fall-animation-option').style.display = theme === 'fall' ? 'block' : 'none';
  document.getElementById('winter-animation-option').style.display = theme === 'winter' ? 'block' : 'none';
}

// Initialize theme preview on page load
updateThemePreview(document.getElementById('site_theme').value);

// Update preview when theme changes
document.getElementById('site_theme').addEventListener('change', function() {
  updateThemePreview(this.value);
});

// Navigation management functions
function getNavItems() {
  const items = [];
  document.querySelectorAll('.nav-item-row').forEach((row, index) => {
    const label = row.querySelector('input[name^="nav_label_"]').value;
    const url = row.querySelector('input[name^="nav_url_"]').value;
    const parent = row.querySelector('select[name^="nav_parent_"]').value;
    const visible = row.querySelector('input[name^="nav_visible_"]').checked;
    items.push({ label, url, parent, visible });
  });
  return items;
}

function updateNavHiddenField() {
  document.getElementById('main_nav_links').value = JSON.stringify(getNavItems());
  document.getElementById('nav_item_count').value = document.querySelectorAll('.nav-item-row').length;
}

function moveNavItem(index, direction) {
  const container = document.getElementById('nav-items-container');
  const rows = Array.from(container.querySelectorAll('.nav-item-row'));
  const newIndex = index + direction;

  if (newIndex < 0 || newIndex >= rows.length) return;

  const currentRow = rows[index];
  const targetRow = rows[newIndex];

  if (direction === -1) {
    container.insertBefore(currentRow, targetRow);
  } else {
    container.insertBefore(targetRow, currentRow);
  }

  // Re-index all rows
  reindexNavItems();
  updateNavHiddenField();
}

function reindexNavItems() {
  document.querySelectorAll('.nav-item-row').forEach((row, index) => {
    row.dataset.index = index;
    row.querySelector('input[name^="nav_label_"]').name = 'nav_label_' + index;
    row.querySelector('input[name^="nav_url_"]').name = 'nav_url_' + index;
    row.querySelector('select[name^="nav_parent_"]').name = 'nav_parent_' + index;
    row.querySelector('input[name^="nav_visible_"]').name = 'nav_visible_' + index;

    // Update button onclick handlers
    const moveUpBtn = row.querySelectorAll('.move-btn')[0];
    const moveDownBtn = row.querySelectorAll('.move-btn')[1];
    const removeBtn = row.querySelector('.remove-nav-btn');

    moveUpBtn.setAttribute('onclick', 'moveNavItem(' + index + ', -1)');
    moveDownBtn.setAttribute('onclick', 'moveNavItem(' + index + ', 1)');
    removeBtn.setAttribute('onclick', 'removeNavItem(' + index + ')');
  });
  updateParentDropdowns();
}

function updateParentDropdowns() {
  const items = getNavItems();
  const topLevelItems = items.filter(item => !item.parent);

  document.querySelectorAll('.nav-parent-select').forEach((select, index) => {
    const currentValue = select.value;
    const currentLabel = items[index].label;

    // Clear and rebuild options
    select.innerHTML = '<option value="">Top level</option>';
    topLevelItems.forEach(item => {
      if (item.label !== currentLabel) {
        const option = document.createElement('option');
        option.value = item.label;
        option.textContent = item.label;
        if (item.label === currentValue) option.selected = true;
        select.appendChild(option);
      }
    });
  });
}

function removeNavItem(index) {
  const rows = document.querySelectorAll('.nav-item-row');
  if (rows.length <= 1) {
    alert('You must have at least one navigation item.');
    return;
  }
  rows[index].remove();
  reindexNavItems();
  updateNavHiddenField();
}

function addNavItem() {
  const container = document.getElementById('nav-items-container');
  const index = container.querySelectorAll('.nav-item-row').length;
  const items = getNavItems();
  const topLevelItems = items.filter(item => !item.parent);

  // Build parent options HTML
  let parentOptions = '<option value="">— None —</option>';
  topLevelItems.forEach(item => {
    parentOptions += `<option value="${item.label}">↳ ${item.label}</option>`;
  });

  const newRow = document.createElement('div');
  newRow.className = 'nav-item-row';
  newRow.dataset.index = index;
  newRow.style.cssText = 'display: grid; grid-template-columns: 60px 1.5fr 1fr 140px 70px 40px; gap: 0.5rem; align-items: center; padding: 0.75rem; background: #F8FAFC; border-radius: 0.5rem; margin-bottom: 0.5rem;';

  newRow.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.25rem;">
      <span style="font-weight: 600; color: #94A3B8; font-size: 0.75rem; width: 20px;">${index + 1}.</span>
      <div class="move-buttons" style="display: flex; flex-direction: column; gap: 2px;">
        <button type="button" onclick="moveNavItem(${index}, -1)" class="move-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move up">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="18 15 12 9 6 15"/></svg>
        </button>
        <button type="button" onclick="moveNavItem(${index}, 1)" class="move-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move down">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
      </div>
    </div>
    <input type="text" name="nav_label_${index}" value="" placeholder="e.g., About Us" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500;">
    <input type="text" name="nav_url_${index}" value="" placeholder="/page-url" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.875rem; font-family: monospace; color: #6366F1;">
    <select name="nav_parent_${index}" class="nav-parent-select" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.8125rem; background: white;">
      ${parentOptions}
    </select>
    <label style="display: flex; align-items: center; justify-content: center; cursor: pointer;">
      <input type="checkbox" name="nav_visible_${index}" value="true" checked style="width: 18px; height: 18px; accent-color: #0077B6;">
    </label>
    <button type="button" onclick="removeNavItem(${index})" class="remove-nav-btn" style="background: none; border: none; cursor: pointer; padding: 0.5rem; color: #EF4444;" title="Remove this item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  `;

  container.appendChild(newRow);
  updateNavHiddenField();
  newRow.querySelector('input[name^="nav_label_"]').focus();
}

// Update hidden field when inputs change
document.getElementById('nav-items-container').addEventListener('input', updateNavHiddenField);
document.getElementById('nav-items-container').addEventListener('change', updateNavHiddenField);

// Credential management functions
function getCredentials() {
  const items = [];
  document.querySelectorAll('.credential-row').forEach((row) => {
    const name = row.querySelector('input[name^="cred_name_"]').value;
    const abbrev = row.querySelector('input[name^="cred_abbrev_"]').value;
    const image = row.querySelector('input[name^="cred_image_"]').value;
    const visible = row.querySelector('input[name^="cred_visible_"]').checked;
    items.push({ name, abbrev, image, visible });
  });
  return items;
}

function updateCredentialsHiddenField() {
  document.getElementById('trust_credentials').value = JSON.stringify(getCredentials());
}

function moveCredential(index, direction) {
  const container = document.getElementById('credentials-container');
  const rows = Array.from(container.querySelectorAll('.credential-row'));
  const newIndex = index + direction;

  if (newIndex < 0 || newIndex >= rows.length) return;

  const currentRow = rows[index];
  const targetRow = rows[newIndex];

  if (direction === -1) {
    container.insertBefore(currentRow, targetRow);
  } else {
    container.insertBefore(targetRow, currentRow);
  }

  reindexCredentials();
  updateCredentialsHiddenField();
}

function reindexCredentials() {
  document.querySelectorAll('.credential-row').forEach((row, index) => {
    row.dataset.index = index;
    row.querySelector('input[name^="cred_name_"]').name = 'cred_name_' + index;
    row.querySelector('input[name^="cred_abbrev_"]').name = 'cred_abbrev_' + index;
    row.querySelector('input[name^="cred_image_"]').name = 'cred_image_' + index;
    row.querySelector('input[name^="cred_visible_"]').name = 'cred_visible_' + index;

    // Update order number display
    row.querySelector('span').textContent = (index + 1) + '.';

    // Update button onclick handlers
    const moveUpBtn = row.querySelectorAll('.move-cred-btn')[0];
    const moveDownBtn = row.querySelectorAll('.move-cred-btn')[1];
    const removeBtn = row.querySelector('.remove-cred-btn');

    moveUpBtn.setAttribute('onclick', 'moveCredential(' + index + ', -1)');
    moveDownBtn.setAttribute('onclick', 'moveCredential(' + index + ', 1)');
    removeBtn.setAttribute('onclick', 'removeCredential(' + index + ')');
  });
}

function removeCredential(index) {
  const rows = document.querySelectorAll('.credential-row');
  if (rows.length <= 1) {
    alert('You must have at least one credential.');
    return;
  }
  rows[index].remove();
  reindexCredentials();
  updateCredentialsHiddenField();
}

function addCredential() {
  const container = document.getElementById('credentials-container');
  const index = container.querySelectorAll('.credential-row').length;

  const newRow = document.createElement('div');
  newRow.className = 'credential-row';
  newRow.dataset.index = index;
  newRow.style.cssText = 'display: grid; grid-template-columns: 50px 1fr 70px 1fr 80px 50px 36px; gap: 0.5rem; align-items: center; padding: 0.75rem; background: #F8FAFC; border-radius: 0.5rem; margin-bottom: 0.5rem;';

  newRow.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.25rem;">
      <span style="font-weight: 600; color: #94A3B8; font-size: 0.75rem; width: 18px;">${index + 1}.</span>
      <div class="move-buttons" style="display: flex; flex-direction: column; gap: 2px;">
        <button type="button" onclick="moveCredential(${index}, -1)" class="move-cred-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move up">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="18 15 12 9 6 15"/></svg>
        </button>
        <button type="button" onclick="moveCredential(${index}, 1)" class="move-cred-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move down">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
      </div>
    </div>
    <input type="text" name="cred_name_${index}" value="" placeholder="e.g., American Dental Association" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.8125rem;">
    <input type="text" name="cred_abbrev_${index}" value="" placeholder="ADA" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.8125rem; text-align: center; font-weight: 600;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <input type="text" name="cred_image_${index}" value="" placeholder="/uploads/logo.png" style="flex: 1; padding: 0.4rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.7rem; font-family: monospace; color: #6366F1;">
    </div>
    <div style="display: flex; justify-content: center;">
      <input type="file" id="cred_file_${index}" accept="image/*" style="display: none;" onchange="uploadCredentialImage(this, ${index})">
      <button type="button" onclick="document.getElementById('cred_file_${index}').click()" class="cred-upload-btn" style="padding: 0.4rem 0.6rem; background: #0077B6; color: white; border: none; border-radius: 0.375rem; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;" title="Upload image">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload
      </button>
    </div>
    <label style="display: flex; align-items: center; justify-content: center; cursor: pointer;">
      <input type="checkbox" name="cred_visible_${index}" value="true" checked style="width: 18px; height: 18px; accent-color: #0077B6;">
    </label>
    <button type="button" onclick="removeCredential(${index})" class="remove-cred-btn" style="background: none; border: none; cursor: pointer; padding: 0.5rem; color: #EF4444;" title="Remove this credential">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  `;

  container.appendChild(newRow);
  updateCredentialsHiddenField();
  newRow.querySelector('input[name^="cred_name_"]').focus();
}

// Upload credential image via AJAX
async function uploadCredentialImage(input, index) {
  if (!input.files || !input.files[0]) return;

  const file = input.files[0];
  const formData = new FormData();
  formData.append('credential_image', file);

  // Find the upload button and show loading state
  const row = input.closest('.credential-row');
  const uploadBtn = row.querySelector('.cred-upload-btn');
  const originalHtml = uploadBtn.innerHTML;
  uploadBtn.innerHTML = '<span style="display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span>';
  uploadBtn.disabled = true;

  try {
    const response = await fetch('/admin/upload-credential-image', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();

    if (data.success) {
      // Update the image path input
      const imageInput = row.querySelector('input[name^="cred_image_"]');
      imageInput.value = data.imagePath;

      // Add or update preview image
      const imageContainer = imageInput.parentElement;
      let previewImg = imageContainer.querySelector('img');
      if (!previewImg) {
        previewImg = document.createElement('img');
        previewImg.style.cssText = 'width: 28px; height: 28px; object-fit: contain; border-radius: 4px; background: white; border: 1px solid #E2E8F0;';
        imageContainer.insertBefore(previewImg, imageInput);
      }
      previewImg.src = data.imagePath;
      previewImg.style.display = 'block';

      // Update hidden field
      updateCredentialsHiddenField();

      // Show success feedback
      uploadBtn.style.background = '#16A34A';
      uploadBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="20 6 9 17 4 12"/></svg>';
      setTimeout(() => {
        uploadBtn.style.background = '#0077B6';
        uploadBtn.innerHTML = originalHtml;
        uploadBtn.disabled = false;
      }, 1500);
    } else {
      alert('Upload failed: ' + data.error);
      uploadBtn.innerHTML = originalHtml;
      uploadBtn.disabled = false;
    }
  } catch (error) {
    alert('Upload failed: ' + error.message);
    uploadBtn.innerHTML = originalHtml;
    uploadBtn.disabled = false;
  }

  // Reset file input
  input.value = '';
}

// Update hidden field when credential inputs change
document.getElementById('credentials-container').addEventListener('input', updateCredentialsHiddenField);
document.getElementById('credentials-container').addEventListener('change', updateCredentialsHiddenField);

// Test email configuration
document.getElementById('test-email-btn').addEventListener('click', async function() {
  const btn = this;
  const resultDiv = document.getElementById('test-email-result');

  btn.disabled = true;
  btn.innerHTML = '<span style="display: inline-block; width: 18px; height: 18px; border: 2px solid #ccc; border-top-color: #333; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 0.5rem;"></span> Testing...';
  resultDiv.style.display = 'none';

  try {
    const response = await fetch('/admin/test-email', { method: 'POST' });
    const data = await response.json();

    resultDiv.style.display = 'block';
    if (data.success) {
      resultDiv.innerHTML = '<div style="padding: 0.75rem; background: #D1FAE5; color: #065F46; border-radius: 0.375rem;">' + data.message + '</div>';
    } else {
      resultDiv.innerHTML = '<div style="padding: 0.75rem; background: #FEE2E2; color: #991B1B; border-radius: 0.375rem;">Error: ' + data.error + '</div>';
    }
  } catch (error) {
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div style="padding: 0.75rem; background: #FEE2E2; color: #991B1B; border-radius: 0.375rem;">Failed to test email configuration</div>';
  }

  btn.disabled = false;
  btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Test Email Configuration';
});
</script>
<style>
@keyframes spin { to { transform: rotate(360deg); } }
</style>

<%- include('partials/footer') %>
