<%- include('../../partials/header', { title, settings, user, currentPath: '/admin/marketing/quiz', unreadCount: 0, newLeadsCount }) %>

<div class="page-header">
  <div>
    <a href="/admin/marketing/quiz" class="btn btn-secondary btn-sm" style="margin-bottom: 0.5rem;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
      Back to Submissions
    </a>
    <h2>Quiz Submission Details</h2>
  </div>
</div>

<div class="content-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
  <!-- Main Content -->
  <div>
    <!-- Contact Information -->
    <div class="card">
      <div class="card-header">
        <h3>Contact Information</h3>
      </div>
      <div class="card-body">
        <div class="info-grid" style="display: grid; gap: 1rem;">
          <div class="info-item">
            <label style="font-size: 0.8rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em;">Name</label>
            <div style="font-size: 1.1rem; font-weight: 500;"><%= submission.first_name || 'Anonymous' %></div>
          </div>

          <% if (submission.email) { %>
          <div class="info-item">
            <label style="font-size: 0.8rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em;">Email</label>
            <div>
              <a href="mailto:<%= submission.email %>" style="color: #0077B6; text-decoration: none;">
                <%= submission.email %>
              </a>
            </div>
          </div>
          <% } %>

          <% if (submission.phone) { %>
          <div class="info-item">
            <label style="font-size: 0.8rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em;">Phone</label>
            <div>
              <a href="tel:<%= submission.phone %>" style="color: #0077B6; text-decoration: none;">
                <%= submission.phone %>
              </a>
            </div>
          </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Quiz Results -->
    <div class="card" style="margin-top: 1.5rem;">
      <div class="card-header">
        <h3>Quiz Results</h3>
      </div>
      <div class="card-body">
        <div class="info-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
          <div class="info-item">
            <label style="font-size: 0.8rem; color: #6B7280; text-transform: uppercase;">Smile Type</label>
            <div style="font-size: 1.1rem; font-weight: 500;">
              <% if (submission.smile_type_name) { %>
                <span class="badge badge-primary" style="font-size: 0.9rem; padding: 0.4rem 0.8rem;"><%= submission.smile_type_name %></span>
              <% } else { %>
                <span class="text-muted">Not determined</span>
              <% } %>
            </div>
          </div>

          <div class="info-item">
            <label style="font-size: 0.8rem; color: #6B7280; text-transform: uppercase;">Primary Interest</label>
            <div style="font-size: 1rem;"><%= submission.primary_interest || 'Not specified' %></div>
          </div>

          <div class="info-item">
            <label style="font-size: 0.8rem; color: #6B7280; text-transform: uppercase;">Timeline</label>
            <div style="font-size: 1rem;"><%= submission.timeline || 'Not specified' %></div>
          </div>

          <div class="info-item">
            <label style="font-size: 0.8rem; color: #6B7280; text-transform: uppercase;">Notification Sent</label>
            <div>
              <% if (submission.notification_sent) { %>
                <span class="badge badge-success">Yes</span>
              <% } else { %>
                <span class="badge badge-secondary">No</span>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recommendations -->
    <% if (recommendations && recommendations.length > 0) { %>
    <div class="card" style="margin-top: 1.5rem;">
      <div class="card-header">
        <h3>Recommended Procedures</h3>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
          <% recommendations.forEach(rec => { %>
            <%
              const procedure = procedures.find(p => p.key === rec.key);
              const name = procedure ? procedure.name : rec.key;
            %>
            <span class="badge badge-outline" style="font-size: 0.85rem; padding: 0.5rem 0.75rem;">
              <%= name %>
              <% if (rec.score) { %> (<%= rec.score %>)<% } %>
            </span>
          <% }) %>
        </div>
      </div>
    </div>
    <% } %>

    <!-- Individual Answers -->
    <% if (answers && answers.length > 0) { %>
    <div class="card" style="margin-top: 1.5rem;">
      <div class="card-header">
        <h3>Quiz Answers</h3>
      </div>
      <div class="card-body">
        <% answers.forEach((answer, index) => { %>
          <div style="padding: 1rem 0; <%= index < answers.length - 1 ? 'border-bottom: 1px solid #E5E7EB;' : '' %>">
            <div style="font-weight: 500; margin-bottom: 0.5rem;"><%= answer.question %></div>
            <div style="color: #6B7280;">
              <%
                let selectedOptions = [];
                try {
                  selectedOptions = JSON.parse(answer.selected_options);
                } catch(e) {
                  selectedOptions = [answer.selected_options];
                }
                if (!Array.isArray(selectedOptions)) selectedOptions = [selectedOptions];
              %>
              <% selectedOptions.forEach(opt => { %>
                <span class="badge badge-secondary" style="margin-right: 0.25rem;"><%= opt %></span>
              <% }) %>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
    <% } %>
  </div>

  <!-- Sidebar -->
  <div>
    <div class="card">
      <div class="card-header">
        <h3>Submission Info</h3>
      </div>
      <div class="card-body">
        <div class="info-item" style="margin-bottom: 1rem;">
          <label style="font-size: 0.8rem; color: #6B7280; text-transform: uppercase;">Submitted</label>
          <div><%= new Date(submission.completed_at).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' }) %></div>
        </div>
        <div class="info-item">
          <label style="font-size: 0.8rem; color: #6B7280; text-transform: uppercase;">Source</label>
          <div><%= submission.source || 'website' %></div>
        </div>
      </div>
    </div>

    <% if (submission.utm_source || submission.utm_medium || submission.utm_campaign) { %>
    <div class="card" style="margin-top: 1rem;">
      <div class="card-header">
        <h3>Campaign</h3>
      </div>
      <div class="card-body">
        <% if (submission.utm_source) { %>
        <div class="info-item" style="margin-bottom: 0.5rem;">
          <label style="font-size: 0.75rem; color: #9CA3AF;">Source</label>
          <div style="font-size: 0.85rem;"><%= submission.utm_source %></div>
        </div>
        <% } %>
        <% if (submission.utm_medium) { %>
        <div class="info-item" style="margin-bottom: 0.5rem;">
          <label style="font-size: 0.75rem; color: #9CA3AF;">Medium</label>
          <div style="font-size: 0.85rem;"><%= submission.utm_medium %></div>
        </div>
        <% } %>
        <% if (submission.utm_campaign) { %>
        <div class="info-item">
          <label style="font-size: 0.75rem; color: #9CA3AF;">Campaign</label>
          <div style="font-size: 0.85rem;"><%= submission.utm_campaign %></div>
        </div>
        <% } %>
      </div>
    </div>
    <% } %>

    <% if (submission.ip_address || submission.user_agent) { %>
    <div class="card" style="margin-top: 1rem;">
      <div class="card-header">
        <h3>Technical Info</h3>
      </div>
      <div class="card-body">
        <% if (submission.ip_address) { %>
        <div class="info-item" style="margin-bottom: 0.5rem;">
          <label style="font-size: 0.75rem; color: #9CA3AF;">IP Address</label>
          <div style="font-size: 0.85rem; color: #6B7280;"><%= submission.ip_address %></div>
        </div>
        <% } %>
        <% if (submission.user_agent) { %>
        <div class="info-item">
          <label style="font-size: 0.75rem; color: #9CA3AF;">User Agent</label>
          <div style="font-size: 0.75rem; color: #9CA3AF; word-break: break-all;"><%= submission.user_agent %></div>
        </div>
        <% } %>
      </div>
    </div>
    <% } %>

    <!-- Quick Actions -->
    <div class="card" style="margin-top: 1rem;">
      <div class="card-header">
        <h3>Quick Actions</h3>
      </div>
      <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <% if (submission.email) { %>
          <a href="mailto:<%= submission.email %>" class="btn btn-secondary btn-sm" style="justify-content: flex-start;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 8px;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            Send Email
          </a>
          <% } %>
          <% if (submission.phone) { %>
          <a href="tel:<%= submission.phone %>" class="btn btn-secondary btn-sm" style="justify-content: flex-start;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 8px;"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
            Call Now
          </a>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../../partials/footer') %>
