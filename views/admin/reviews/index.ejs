<%- include('../partials/header') %>

<% if (typeof syncMessage !== 'undefined' && syncMessage) { %>
<div class="alert alert-success" style="margin-bottom: 1.5rem;">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
  <%= syncMessage %>
</div>
<% } %>

<% if (typeof syncError !== 'undefined' && syncError) { %>
<div class="alert alert-danger" style="margin-bottom: 1.5rem;">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
  <%= syncError %>
</div>
<% } %>

<!-- Google Reviews Sync Section -->
<div class="card" style="margin-bottom: 2rem; border: 2px solid #EA4335;">
  <div class="card-header" style="background: linear-gradient(135deg, #EA4335 0%, #FBBC05 50%, #34A853 75%, #4285F4 100%); color: white;">
    <h2 style="display: flex; align-items: center; gap: 0.5rem;">
      <svg viewBox="0 0 24 24" fill="currentColor" style="width: 24px; height: 24px;">
        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Google Reviews
    </h2>
    <% if (googleSync && googleSync.isConfigured) { %>
      <form action="/admin/reviews/sync-google" method="POST" style="display: inline;">
        <button type="submit" class="btn" style="background: white; color: #333;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
          Sync Now
        </button>
      </form>
    <% } %>
  </div>
  <div class="card-body">
    <% if (googleSync && googleSync.isConfigured) { %>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
        <div style="text-align: center; padding: 1rem; background: #F8FAFC; border-radius: 8px;">
          <div style="font-size: 2rem; font-weight: 700; color: #EA4335;"><%= googleSync.overallRating || '—' %></div>
          <div style="font-size: 0.875rem; color: #64748B;">Google Rating</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #F8FAFC; border-radius: 8px;">
          <div style="font-size: 2rem; font-weight: 700; color: #4285F4;"><%= googleSync.totalReviews || '—' %></div>
          <div style="font-size: 0.875rem; color: #64748B;">Total Reviews</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #F8FAFC; border-radius: 8px;">
          <div style="font-size: 2rem; font-weight: 700; color: #34A853;"><%= countBySource.find(s => s.source === 'google')?.count || 0 %></div>
          <div style="font-size: 0.875rem; color: #64748B;">Imported</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #F8FAFC; border-radius: 8px;">
          <div style="font-size: 0.875rem; font-weight: 600; color: #334155;">
            <% if (googleSync.lastSync) { %>
              <%= new Date(googleSync.lastSync).toLocaleDateString() %><br>
              <%= new Date(googleSync.lastSync).toLocaleTimeString() %>
            <% } else { %>
              Never
            <% } %>
          </div>
          <div style="font-size: 0.875rem; color: #64748B;">Last Sync</div>
        </div>
      </div>
      <p style="margin-top: 1rem; font-size: 0.875rem; color: #64748B;">
        Click "Sync Now" to fetch the latest reviews from Google. New reviews will be imported automatically. You can then mark specific reviews as "Featured" to highlight them.
      </p>
    <% } else { %>
      <div style="text-align: center; padding: 2rem;">
        <svg viewBox="0 0 24 24" fill="none" stroke="#EA4335" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 1rem;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <h3 style="margin-bottom: 0.5rem;">Google Places API Not Configured</h3>
        <p style="color: #64748B; margin-bottom: 1rem;">To fetch reviews from Google, you need to configure your API key and Place ID in Settings.</p>
        <a href="/admin/settings" class="btn btn-primary">Go to Settings</a>
      </div>
    <% } %>
  </div>
</div>

<% if (stats && stats.total > 0) { %>
<div class="stats-grid" style="margin-bottom: 2rem;">
  <div class="stat-card">
    <div class="stat-icon" style="background: var(--color-primary);">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
    </div>
    <div class="stat-content">
      <div class="stat-value"><%= stats.total %></div>
      <div class="stat-label">Total Reviews</div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon" style="background: #10B981;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
    </div>
    <div class="stat-content">
      <div class="stat-value"><%= stats.average_rating ? stats.average_rating.toFixed(1) : '0.0' %></div>
      <div class="stat-label">Average Rating</div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon" style="background: #F59E0B;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
    </div>
    <div class="stat-content">
      <div class="stat-value"><%= stats.five_star || 0 %></div>
      <div class="stat-label">5-Star Reviews</div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon" style="background: #6366F1;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    </div>
    <div class="stat-content">
      <div class="stat-value"><%= countBySource.length %></div>
      <div class="stat-label">Sources</div>
    </div>
  </div>
</div>

<% if (countBySource.length > 0) { %>
<div class="card" style="margin-bottom: 2rem;">
  <div class="card-header">
    <h2>Reviews by Source</h2>
  </div>
  <div class="card-body">
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <% countBySource.forEach(function(item) { %>
        <div style="background: var(--bg-secondary); padding: 0.75rem 1.25rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
          <% if (item.source === 'google') { %>
            <span style="color: #EA4335;">G</span>
          <% } else if (item.source === 'yelp') { %>
            <span style="color: #D32323;">Y</span>
          <% } else if (item.source === 'facebook') { %>
            <span style="color: #1877F2;">f</span>
          <% } else { %>
            <span style="color: var(--text-secondary);">M</span>
          <% } %>
          <span style="text-transform: capitalize;"><%= item.source %></span>
          <span class="badge"><%= item.count %></span>
        </div>
      <% }); %>
    </div>
  </div>
</div>
<% } %>
<% } %>

<div class="card">
  <div class="card-header">
    <h2>Reviews</h2>
    <a href="/admin/reviews/new" class="btn btn-primary">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Review
    </a>
  </div>

  <% if (reviews.length === 0) { %>
  <div class="card-body">
    <div class="empty-state">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 48px; height: 48px; color: var(--text-muted);"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      <h3>No reviews yet</h3>
      <p>Add your first review to get started.</p>
      <a href="/admin/reviews/new" class="btn btn-primary">Add Review</a>
    </div>
  </div>
  <% } else { %>
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>Reviewer</th>
          <th>Content</th>
          <th>Rating</th>
          <th>Source</th>
          <th>Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% reviews.forEach(function(r) { %>
        <tr>
          <td>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <% if (r.reviewer_photo) { %>
                <img src="<%= r.reviewer_photo %>" alt="<%= r.reviewer_name %>" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
              <% } else { %>
                <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;"><%= r.reviewer_name.charAt(0).toUpperCase() %></div>
              <% } %>
              <div>
                <strong><%= r.reviewer_name %></strong>
                <% if (r.featured) { %><span class="badge" style="margin-left: 0.5rem; background: #F59E0B;">Featured</span><% } %>
              </div>
            </div>
          </td>
          <td style="max-width: 300px;"><%= r.content.length > 100 ? r.content.substring(0, 100) + '...' : r.content %></td>
          <td><%= '⭐'.repeat(r.rating) %></td>
          <td>
            <span class="badge" style="text-transform: capitalize;
              <% if (r.source === 'google') { %>background: #EA4335;<% }
                 else if (r.source === 'yelp') { %>background: #D32323;<% }
                 else if (r.source === 'facebook') { %>background: #1877F2;<% }
                 else { %>background: var(--text-secondary);<% } %>">
              <%= r.source %>
            </span>
          </td>
          <td><%= r.review_date ? new Date(r.review_date).toLocaleDateString() : '-' %></td>
          <td>
            <span class="badge <%= r.status === 'published' ? 'badge-success' : 'badge-secondary' %>">
              <%= r.status %>
            </span>
          </td>
          <td>
            <div class="actions">
              <a href="/admin/reviews/<%= r.id %>/edit" class="btn btn-secondary btn-sm btn-icon" title="Edit">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </a>
              <form action="/admin/reviews/<%= r.id %>/delete" method="POST" class="delete-form" style="display: inline;">
                <button type="submit" class="btn btn-danger btn-sm btn-icon" title="Delete">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                </button>
              </form>
            </div>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
  <% } %>
</div>

<%- include('../partials/footer') %>
