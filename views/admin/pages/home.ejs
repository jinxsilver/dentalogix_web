<%- include('../partials/header') %>

<% if (typeof success !== 'undefined' && success) { %>
<div class="alert alert-success">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
  Home page settings saved successfully!
</div>
<% } %>

<div style="margin-bottom: 1.5rem;">
  <a href="/admin/pages" class="btn btn-secondary">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
    Back to Pages
  </a>
</div>

<form action="/admin/pages/home" method="POST" enctype="multipart/form-data">
  <!-- Problem Section Images - Full Width -->
  <div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
      <h2>Problem Section Images</h2>
    </div>
    <div class="card-body">
      <p style="color: #64748B; font-size: 0.875rem; margin-bottom: 1.5rem;">These images appear in the "The Problem" section on the homepage. Upload custom illustrations to match your brand.</p>

      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
        <!-- Villain Image -->
        <div class="form-group">
          <label for="problem_villain_image">Villain Card</label>
          <div style="margin-bottom: 0.5rem; padding: 0.75rem; background: #FEF3C7; border-radius: 0.5rem; text-align: center; min-height: 100px; display: flex; align-items: center; justify-content: center;">
            <% if (settings.problem_villain_image) { %>
              <img src="<%= settings.problem_villain_image %>" alt="Villain" style="max-height: 80px; max-width: 100%; object-fit: contain; border-radius: 0.375rem;">
            <% } else { %>
              <span style="color: #92400E; font-size: 0.75rem;">No image</span>
            <% } %>
          </div>
          <input type="file" id="problem_villain_image" name="problem_villain_image" accept="image/png,image/jpeg,image/webp,image/gif" style="width: 100%; padding: 0.4rem; border: 1px solid #E2E8F0; border-radius: 0.5rem; font-size: 0.8rem;">
          <small style="color: #64748B; display: block; margin-top: 0.25rem; font-size: 0.75rem;">Main card (anxious person)</small>
        </div>

        <!-- External Problem Image -->
        <div class="form-group">
          <label for="problem_external_image">External Problem</label>
          <div style="margin-bottom: 0.5rem; padding: 0.75rem; background: #FFF8F0; border-radius: 0.5rem; text-align: center; min-height: 100px; display: flex; align-items: center; justify-content: center;">
            <% if (settings.problem_external_image) { %>
              <img src="<%= settings.problem_external_image %>" alt="External Problem" style="max-height: 80px; max-width: 100%; object-fit: contain; border-radius: 0.375rem;">
            <% } else { %>
              <span style="color: #9A7B4F; font-size: 0.75rem;">No image</span>
            <% } %>
          </div>
          <input type="file" id="problem_external_image" name="problem_external_image" accept="image/png,image/jpeg,image/webp,image/gif" style="width: 100%; padding: 0.4rem; border: 1px solid #E2E8F0; border-radius: 0.5rem; font-size: 0.8rem;">
          <small style="color: #64748B; display: block; margin-top: 0.25rem; font-size: 0.75rem;">Family/group icon</small>
        </div>

        <!-- Internal Problem Image -->
        <div class="form-group">
          <label for="problem_internal_image">How It Feels</label>
          <div style="margin-bottom: 0.5rem; padding: 0.75rem; background: #FFF8F0; border-radius: 0.5rem; text-align: center; min-height: 100px; display: flex; align-items: center; justify-content: center;">
            <% if (settings.problem_internal_image) { %>
              <img src="<%= settings.problem_internal_image %>" alt="Internal Problem" style="max-height: 80px; max-width: 100%; object-fit: contain; border-radius: 0.375rem;">
            <% } else { %>
              <span style="color: #9A7B4F; font-size: 0.75rem;">No image</span>
            <% } %>
          </div>
          <input type="file" id="problem_internal_image" name="problem_internal_image" accept="image/png,image/jpeg,image/webp,image/gif" style="width: 100%; padding: 0.4rem; border: 1px solid #E2E8F0; border-radius: 0.5rem; font-size: 0.8rem;">
          <small style="color: #64748B; display: block; margin-top: 0.25rem; font-size: 0.75rem;">Worried face emoji</small>
        </div>

        <!-- Philosophical Problem Image -->
        <div class="form-group">
          <label for="problem_philosophical_image">Why It's Wrong</label>
          <div style="margin-bottom: 0.5rem; padding: 0.75rem; background: #FEF3C7; border-radius: 0.5rem; text-align: center; min-height: 100px; display: flex; align-items: center; justify-content: center;">
            <% if (settings.problem_philosophical_image) { %>
              <img src="<%= settings.problem_philosophical_image %>" alt="Philosophical Problem" style="max-height: 80px; max-width: 100%; object-fit: contain; border-radius: 0.375rem;">
            <% } else { %>
              <span style="color: #92400E; font-size: 0.75rem;">No image</span>
            <% } %>
          </div>
          <input type="file" id="problem_philosophical_image" name="problem_philosophical_image" accept="image/png,image/jpeg,image/webp,image/gif" style="width: 100%; padding: 0.4rem; border: 1px solid #E2E8F0; border-radius: 0.5rem; font-size: 0.8rem;">
          <small style="color: #64748B; display: block; margin-top: 0.25rem; font-size: 0.75rem;">Hand/care icon</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Stakes Section Image - Full Width -->
  <div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
      <h2>Stakes Section Image</h2>
    </div>
    <div class="card-body">
      <p style="color: #64748B; font-size: 0.875rem; margin-bottom: 1.5rem;">Upload a custom image for the Stakes section. This image displays full-width between the Plan and Services sections. If no image is uploaded, the section will be hidden.</p>

      <div class="form-group">
        <label for="stakes_section_image">Section Image</label>
        <% if (settings.stakes_section_image) { %>
          <div style="margin-bottom: 1rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem;">
            <p style="font-size: 0.875rem; color: #64748B; margin-bottom: 0.5rem;">Current image:</p>
            <img src="<%= settings.stakes_section_image %>" alt="Stakes Section" style="max-width: 100%; max-height: 200px; object-fit: contain; border-radius: 0.375rem;">
          </div>
        <% } else { %>
          <div style="margin-bottom: 1rem; padding: 2rem; background: #F8FAFC; border-radius: 0.5rem; text-align: center; border: 2px dashed #E2E8F0;">
            <span style="color: #94A3B8; font-size: 0.875rem;">No image uploaded - section will be hidden</span>
          </div>
        <% } %>
        <input type="file" id="stakes_section_image" name="stakes_section_image" accept="image/png,image/jpeg,image/webp,image/gif" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.5rem;">
        <small style="color: #64748B; display: block; margin-top: 0.5rem;">This image displays full-width on the homepage. Use a wide banner-style image for best results.</small>
      </div>
    </div>
  </div>

  <!-- Trust Credentials Section -->
  <div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
      <h2>Trust Credentials</h2>
    </div>
    <div class="card-body">
      <p style="color: #64748B; font-size: 0.875rem; margin-bottom: 1.5rem;">Manage the "Trusted & Accredited" logos displayed below the hero section on your homepage.</p>

      <div id="credentials-container">
        <%
          let credentials = [];
          try {
            credentials = JSON.parse(settings.trust_credentials || '[]');
          } catch (e) {
            credentials = [];
          }
          // Default credentials if none configured
          if (credentials.length === 0) {
            credentials = [
              { name: 'American Dental Association', abbrev: 'ADA', image: '/images/credentials/ada-logo.png', visible: true },
              { name: 'NYU College of Dentistry', abbrev: 'NYU', image: '/images/credentials/nyu-dentistry-logo.png', visible: true },
              { name: 'New York State Licensed', abbrev: 'NY', image: '/images/credentials/ny-dental-license.png', visible: true },
              { name: 'Connecticut State Licensed', abbrev: 'CT', image: '/images/credentials/ct-dental-license.png', visible: true }
            ];
          }
        %>
        <!-- Column Headers -->
        <div style="display: grid; grid-template-columns: 50px 1fr 70px 1fr 80px 50px 36px; gap: 0.5rem; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; font-size: 0.7rem; font-weight: 600; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px;">
          <div>Order</div>
          <div>Credential Name</div>
          <div>Abbrev</div>
          <div>Image</div>
          <div style="text-align: center;">Upload</div>
          <div style="text-align: center;">Show</div>
          <div></div>
        </div>

        <% credentials.forEach((cred, index) => { %>
        <div class="credential-row" data-index="<%= index %>" style="display: grid; grid-template-columns: 50px 1fr 70px 1fr 80px 50px 36px; gap: 0.5rem; align-items: center; padding: 0.75rem; background: #F8FAFC; border-radius: 0.5rem; margin-bottom: 0.5rem;">
          <!-- Order/Move buttons -->
          <div style="display: flex; align-items: center; gap: 0.25rem;">
            <span style="font-weight: 600; color: #94A3B8; font-size: 0.75rem; width: 18px;"><%= index + 1 %>.</span>
            <div class="move-buttons" style="display: flex; flex-direction: column; gap: 2px;">
              <button type="button" onclick="moveCredential(<%= index %>, -1)" class="move-cred-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move up">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="18 15 12 9 6 15"/></svg>
              </button>
              <button type="button" onclick="moveCredential(<%= index %>, 1)" class="move-cred-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move down">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
            </div>
          </div>

          <!-- Credential Name -->
          <input type="text" name="cred_name_<%= index %>" value="<%= cred.name %>" placeholder="e.g., American Dental Association" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.8125rem;">

          <!-- Abbreviation -->
          <input type="text" name="cred_abbrev_<%= index %>" value="<%= cred.abbrev %>" placeholder="ADA" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.8125rem; text-align: center; font-weight: 600;">

          <!-- Image Path with Preview -->
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <% if (cred.image) { %>
            <img src="<%= cred.image %>" alt="" style="width: 28px; height: 28px; object-fit: contain; border-radius: 4px; background: white; border: 1px solid #E2E8F0;" onerror="this.style.display='none'">
            <% } %>
            <input type="text" name="cred_image_<%= index %>" value="<%= cred.image %>" placeholder="/uploads/logo.png" style="flex: 1; padding: 0.4rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.7rem; font-family: monospace; color: #6366F1;">
          </div>

          <!-- Upload Button -->
          <div style="display: flex; justify-content: center;">
            <input type="file" id="cred_file_<%= index %>" accept="image/*" style="display: none;" onchange="uploadCredentialImage(this, <%= index %>)">
            <button type="button" onclick="document.getElementById('cred_file_<%= index %>').click()" class="cred-upload-btn" style="padding: 0.4rem 0.6rem; background: #0077B6; color: white; border: none; border-radius: 0.375rem; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;" title="Upload image">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Upload
            </button>
          </div>

          <!-- Visible Toggle -->
          <label style="display: flex; align-items: center; justify-content: center; cursor: pointer;">
            <input type="checkbox" name="cred_visible_<%= index %>" value="true" <%= cred.visible !== false ? 'checked' : '' %> style="width: 18px; height: 18px; accent-color: #0077B6;">
          </label>

          <!-- Delete -->
          <button type="button" onclick="removeCredential(<%= index %>)" class="remove-cred-btn" style="background: none; border: none; cursor: pointer; padding: 0.5rem; color: #EF4444;" title="Remove this credential">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <% }); %>
      </div>

      <input type="hidden" id="trust_credentials" name="trust_credentials" value='<%= JSON.stringify(credentials) %>'>

      <button type="button" onclick="addCredential()" class="btn btn-secondary" style="margin-top: 1rem;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Credential
      </button>

      <div style="margin-top: 1rem; padding: 0.75rem; background: #D1FAE5; border-radius: 0.375rem; font-size: 0.875rem; color: #065F46;">
        <strong>Tip:</strong> Click "Upload" to add a logo image, or manually enter a path if the image already exists on the server.
      </div>
    </div>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">

    <!-- Guide Section Images (renamed from About) -->
    <div class="card">
      <div class="card-header">
        <h2>Guide Section Images</h2>
      </div>
      <div class="card-body">
        <p style="color: #64748B; font-size: 0.875rem; margin-bottom: 1.5rem;">These images appear in the "Guide" section on the homepage, showing your practice as the trusted guide.</p>

        <div class="form-group">
          <label for="about_image_main">Main Image (Large)</label>
          <% if (settings.about_image_main) { %>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem;">
              <p style="font-size: 0.875rem; color: #64748B; margin-bottom: 0.5rem;">Current image:</p>
              <img src="<%= settings.about_image_main %>" alt="About main" style="max-height: 120px; max-width: 100%; object-fit: cover; border-radius: 0.5rem;">
            </div>
          <% } %>
          <input type="file" id="about_image_main" name="about_image_main" accept="image/*" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.5rem;">
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Recommended: 600x400px or similar. This is the larger image.</small>
        </div>

        <div class="form-group" style="margin-top: 1.5rem;">
          <label for="about_image_secondary">Secondary Image (Small)</label>
          <% if (settings.about_image_secondary) { %>
            <div style="margin-bottom: 1rem; padding: 1rem; background: #F8FAFC; border-radius: 0.5rem;">
              <p style="font-size: 0.875rem; color: #64748B; margin-bottom: 0.5rem;">Current image:</p>
              <img src="<%= settings.about_image_secondary %>" alt="About secondary" style="max-height: 100px; max-width: 100%; object-fit: cover; border-radius: 0.5rem;">
            </div>
          <% } %>
          <input type="file" id="about_image_secondary" name="about_image_secondary" accept="image/*" style="width: 100%; padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.5rem;">
          <small style="color: #64748B; display: block; margin-top: 0.5rem;">Recommended: 300x200px or similar. This is the smaller overlapping image.</small>
        </div>
      </div>
    </div>

    <!-- Quick Links -->
    <div class="card">
      <div class="card-header">
        <h2>Home Page Quick Links</h2>
      </div>
      <div class="card-body">
        <p style="color: #64748B; font-size: 0.875rem; margin-bottom: 1.5rem;">Manage other home page sections:</p>

        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
          <a href="/admin/services" class="btn btn-secondary" style="width: 100%; justify-content: flex-start;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
            Manage Featured Services
          </a>

          <a href="/admin/testimonials" class="btn btn-secondary" style="width: 100%; justify-content: flex-start;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>
            Manage Testimonials
          </a>

          <a href="/admin/reviews" class="btn btn-secondary" style="width: 100%; justify-content: flex-start;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            Manage Reviews
          </a>

          <a href="/admin/team" class="btn btn-secondary" style="width: 100%; justify-content: flex-start;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
            Manage Team Members
          </a>

          <a href="/admin/insurance" class="btn btn-secondary" style="width: 100%; justify-content: flex-start;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            Manage Insurance Providers
          </a>

          <a href="/admin/posts" class="btn btn-secondary" style="width: 100%; justify-content: flex-start;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 0.5rem;"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            Manage Blog Posts (Recent Posts)
          </a>
        </div>

        <div style="margin-top: 1.5rem; padding: 1rem; background: #EFF6FF; border-radius: 0.5rem;">
          <p style="font-size: 0.875rem; color: #1E40AF; margin: 0;">
            <strong>Tip:</strong> Hero section text and site name can be edited in <a href="/admin/settings" style="color: #1E40AF; text-decoration: underline;">Settings</a>.
          </p>
        </div>
      </div>
    </div>

  </div>

  <div style="margin-top: 1.5rem;">
    <button type="submit" class="btn btn-primary btn-lg">Save Home Page Settings</button>
  </div>
</form>

<script>
// Trust Credentials Management Functions
function getCredentials() {
  const items = [];
  document.querySelectorAll('.credential-row').forEach((row) => {
    const name = row.querySelector('input[name^="cred_name_"]').value;
    const abbrev = row.querySelector('input[name^="cred_abbrev_"]').value;
    const image = row.querySelector('input[name^="cred_image_"]').value;
    const visible = row.querySelector('input[name^="cred_visible_"]').checked;
    items.push({ name, abbrev, image, visible });
  });
  return items;
}

function updateCredentialsHiddenField() {
  document.getElementById('trust_credentials').value = JSON.stringify(getCredentials());
}

function moveCredential(index, direction) {
  const container = document.getElementById('credentials-container');
  const rows = Array.from(container.querySelectorAll('.credential-row'));
  const newIndex = index + direction;

  if (newIndex < 0 || newIndex >= rows.length) return;

  const currentRow = rows[index];
  const targetRow = rows[newIndex];

  if (direction === -1) {
    container.insertBefore(currentRow, targetRow);
  } else {
    container.insertBefore(targetRow, currentRow);
  }

  reindexCredentials();
  updateCredentialsHiddenField();
}

function reindexCredentials() {
  document.querySelectorAll('.credential-row').forEach((row, index) => {
    row.dataset.index = index;
    row.querySelector('input[name^="cred_name_"]').name = 'cred_name_' + index;
    row.querySelector('input[name^="cred_abbrev_"]').name = 'cred_abbrev_' + index;
    row.querySelector('input[name^="cred_image_"]').name = 'cred_image_' + index;
    row.querySelector('input[name^="cred_visible_"]').name = 'cred_visible_' + index;

    // Update order number display
    row.querySelector('span').textContent = (index + 1) + '.';

    // Update button onclick handlers
    const moveUpBtn = row.querySelectorAll('.move-cred-btn')[0];
    const moveDownBtn = row.querySelectorAll('.move-cred-btn')[1];
    const removeBtn = row.querySelector('.remove-cred-btn');
    const fileInput = row.querySelector('input[type="file"]');
    const uploadBtn = row.querySelector('.cred-upload-btn');

    moveUpBtn.setAttribute('onclick', 'moveCredential(' + index + ', -1)');
    moveDownBtn.setAttribute('onclick', 'moveCredential(' + index + ', 1)');
    removeBtn.setAttribute('onclick', 'removeCredential(' + index + ')');
    fileInput.id = 'cred_file_' + index;
    fileInput.setAttribute('onchange', 'uploadCredentialImage(this, ' + index + ')');
    uploadBtn.setAttribute('onclick', "document.getElementById('cred_file_" + index + "').click()");
  });
}

function removeCredential(index) {
  const rows = document.querySelectorAll('.credential-row');
  if (rows.length <= 1) {
    alert('You must have at least one credential.');
    return;
  }
  rows[index].remove();
  reindexCredentials();
  updateCredentialsHiddenField();
}

function addCredential() {
  const container = document.getElementById('credentials-container');
  const index = container.querySelectorAll('.credential-row').length;

  const newRow = document.createElement('div');
  newRow.className = 'credential-row';
  newRow.dataset.index = index;
  newRow.style.cssText = 'display: grid; grid-template-columns: 50px 1fr 70px 1fr 80px 50px 36px; gap: 0.5rem; align-items: center; padding: 0.75rem; background: #F8FAFC; border-radius: 0.5rem; margin-bottom: 0.5rem;';

  newRow.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.25rem;">
      <span style="font-weight: 600; color: #94A3B8; font-size: 0.75rem; width: 18px;">${index + 1}.</span>
      <div class="move-buttons" style="display: flex; flex-direction: column; gap: 2px;">
        <button type="button" onclick="moveCredential(${index}, -1)" class="move-cred-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move up">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="18 15 12 9 6 15"/></svg>
        </button>
        <button type="button" onclick="moveCredential(${index}, 1)" class="move-cred-btn" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748B;" title="Move down">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
      </div>
    </div>
    <input type="text" name="cred_name_${index}" value="" placeholder="e.g., American Dental Association" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.8125rem;">
    <input type="text" name="cred_abbrev_${index}" value="" placeholder="ADA" style="padding: 0.5rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.8125rem; text-align: center; font-weight: 600;">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <input type="text" name="cred_image_${index}" value="" placeholder="/uploads/logo.png" style="flex: 1; padding: 0.4rem; border: 1px solid #E2E8F0; border-radius: 0.375rem; font-size: 0.7rem; font-family: monospace; color: #6366F1;">
    </div>
    <div style="display: flex; justify-content: center;">
      <input type="file" id="cred_file_${index}" accept="image/*" style="display: none;" onchange="uploadCredentialImage(this, ${index})">
      <button type="button" onclick="document.getElementById('cred_file_${index}').click()" class="cred-upload-btn" style="padding: 0.4rem 0.6rem; background: #0077B6; color: white; border: none; border-radius: 0.375rem; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;" title="Upload image">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload
      </button>
    </div>
    <label style="display: flex; align-items: center; justify-content: center; cursor: pointer;">
      <input type="checkbox" name="cred_visible_${index}" value="true" checked style="width: 18px; height: 18px; accent-color: #0077B6;">
    </label>
    <button type="button" onclick="removeCredential(${index})" class="remove-cred-btn" style="background: none; border: none; cursor: pointer; padding: 0.5rem; color: #EF4444;" title="Remove this credential">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  `;

  container.appendChild(newRow);
  updateCredentialsHiddenField();
  newRow.querySelector('input[name^="cred_name_"]').focus();
}

// Upload credential image via AJAX
async function uploadCredentialImage(input, index) {
  if (!input.files || !input.files[0]) return;

  const file = input.files[0];
  const formData = new FormData();
  formData.append('credential_image', file);

  // Find the upload button and show loading state
  const row = input.closest('.credential-row');
  const uploadBtn = row.querySelector('.cred-upload-btn');
  const originalHtml = uploadBtn.innerHTML;
  uploadBtn.innerHTML = '<span style="display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span>';
  uploadBtn.disabled = true;

  try {
    const response = await fetch('/admin/upload-credential-image', {
      method: 'POST',
      body: formData
    });
    const data = await response.json();

    if (data.success) {
      // Update the image path input
      const imageInput = row.querySelector('input[name^="cred_image_"]');
      imageInput.value = data.imagePath;

      // Add or update preview image
      const imageContainer = imageInput.parentElement;
      let previewImg = imageContainer.querySelector('img');
      if (!previewImg) {
        previewImg = document.createElement('img');
        previewImg.style.cssText = 'width: 28px; height: 28px; object-fit: contain; border-radius: 4px; background: white; border: 1px solid #E2E8F0;';
        imageContainer.insertBefore(previewImg, imageInput);
      }
      previewImg.src = data.imagePath;
      previewImg.style.display = 'block';

      // Update hidden field
      updateCredentialsHiddenField();

      // Show success feedback
      uploadBtn.style.background = '#16A34A';
      uploadBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="20 6 9 17 4 12"/></svg>';
      setTimeout(() => {
        uploadBtn.style.background = '#0077B6';
        uploadBtn.innerHTML = originalHtml;
        uploadBtn.disabled = false;
      }, 1500);
    } else {
      alert('Upload failed: ' + data.error);
      uploadBtn.innerHTML = originalHtml;
      uploadBtn.disabled = false;
    }
  } catch (error) {
    alert('Upload failed: ' + error.message);
    uploadBtn.innerHTML = originalHtml;
    uploadBtn.disabled = false;
  }

  // Reset file input
  input.value = '';
}

// Update hidden field when credential inputs change
document.getElementById('credentials-container').addEventListener('input', updateCredentialsHiddenField);
document.getElementById('credentials-container').addEventListener('change', updateCredentialsHiddenField);
</script>

<style>
@keyframes spin { to { transform: rotate(360deg); } }
</style>

<%- include('../partials/footer') %>
